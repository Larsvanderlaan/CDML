---
title: "simsDR"
output: html_document
date: '2023-07-05'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(data.table)
results <- rbindlist(lapply(c(500, 1000, 1500, 2000, 2500), function(n) {
  out <- fread(paste0("simResultsDR/sim_results_DR_iter=1000_n=", n, "_pos=2.csv"))
  out$n <- n
  return(out)
}))
results
```

```{r}
library(ggplot2)
out <-  sim_results_acic2018_10000_xgboost
results <- as.data.table(out)
keep <- !rep(abs(results$estimate[out$estimator == "auDRI"]) >= 10 * max(abs(results$ATE)) | abs(results$estimate[results$estimator == "AIPW"]) >= 10 * max(abs(results$ATE)), each = 2)
results <- results[which(keep),]
 
# results$ATE <-ATE
results[, coverage := CI_left <= ATE & CI_right >= ATE]
 
 
results <- unique(results[,
                         .( bias = abs(mean((estimate - ATE) )), 
                           rmse  = sqrt(mean((estimate - ATE)^2)),
                          coverage = mean(coverage)), by = c( "misp",   "estimator", "lrnr")])
 
 
results <- results[results$misp !=4, ]
results
 

 
```





```{r}
library(data.table)
out <- sim_results_DR_iter_1000_n_2500_pos_2
results <- as.data.table(out)
ATE <- mean(results$ATE)
results$ATE <-ATE
results[, coverage := CI_left <= ATE & CI_right >= ATE]
results[, sd := abs(CI_left -CI_right)/1.96/2]


results <- unique(results[, .(sd = mean(sd), se = sd(estimate-ATE), bias = abs(mean(estimate - ATE)), coverage = mean(coverage)), by = c( "misp",   "estimator", "lrnr")])
results[, rmse := sqrt(bias^2 + se^2)]

results$rmse <- results$rmse /abs(ATE)
results$se <- results$se /abs(ATE)
results$sd <- results$sd /abs(ATE)
results$bias <- results$bias /abs(ATE)
results <- results[results$misp !=4, ]
results
results[results$lrnr=="all"]


```

Do table

For each lrnr.
n  Treatment Outcome Both
mse (coverage)


```{r}
results[results$lrnr=="xgboost",]

```

```{r}
library(data.table)

n_list <- c(  1000, 1500, 2000, 2500)

results <-
  rbindlist(lapply(n_list, function(n){
    try({
      key <- paste0("DR_iter=", "1000", "_n=", n, "_pos=2")
      data <- fread(paste0("./simResultsDR/sim_results_", key, ".csv"))
      key <- paste0("DR_iter=", "2000", "_n=", n, "_pos=2")
      try({ data <- fread(paste0("./simResultsDR/sim_results_", key, ".csv"))})
      return(data)
    })
    return(data.table())
  }))



ATE <- mean(results$ATE)
results$ATE <-ATE
results[, coverage := CI_left <= ATE & CI_right >= ATE]
results[, sd := abs(CI_left -CI_right)/1.96/2]


results <- unique(results[, .(sd = mean(sd), se = sd(estimate-ATE), bias = abs(mean(estimate - ATE)), coverage = mean(coverage)), by = c( "misp",   "estimator", "lrnr", "n", "pos_const")])
results[, rmse := sqrt(bias^2 + se^2)]
relative_results <- unique(copy(results)[,-c("estimator"), with = FALSE])
keep_index <- which(results$estimator == "auDRI")
relative_results <- data.table(bias = results$bias[results$estimator == "auDRI"] / results$bias[results$estimator == "AIPW"], rmse = results$rmse[results$estimator == "auDRI"] / results$rmse[results$estimator == "AIPW"] )
relative_results <- cbind(results[keep_index, c("misp", "lrnr", "n")], relative_results)
  
relative_results

  library(ggplot2)
w <- 7
h <- 5
results$misp <- c("Both", "Treatment", "Outcome" )[match(results$misp, c("1", "2", "3" ))]
relative_results$misp <- c("Both", "Treatment", "Outcome" )[match(relative_results$misp, c("1", "2", "3" ))]

for(lrnr in c("all")) {
  for(misp in c("Both", "Treatment", "Outcome" )) {
    #relative_results_sub$lrnr == lrnr &
    results_sub <- as.data.frame(results)
    relative_results_sub <- as.data.frame(relative_results)
    results_sub <- results_sub[  results_sub$misp == misp,]
    relative_results_sub <- relative_results_sub[  relative_results_sub$misp == misp,]

  
    p <-  ggplot(relative_results_sub, aes(x= n, y = bias, color = lrnr, shape= lrnr)) + geom_point(size = 4) + geom_line( color="grey", linetype = "dashed")   + theme_bw() +     theme(  text = element_text(size=18), axis.text.x = element_text(size = 14 , hjust = 1, vjust = 0.5), legend.position = "bottom",   legend.box = "horizontal" 
    )  + labs(x = "Sample Size (n)", y = "Bias", color = "Estimator", group = "Estimator", shape= "Estimator") 
    
    ggsave(   filename = paste0("DR=", pos_const,lrnr,misp, "Bias.pdf") , width = w, height = h)
    
    
    
      p <-  ggplot(relative_results_sub, aes(x= n, y = rmse, color = lrnr, shape= lrnr)) + geom_point(size = 4) + geom_line( color="grey", linetype = "dashed")   + theme_bw() +     theme(  text = element_text(size=18), axis.text.x = element_text(size = 14 , hjust = 1, vjust = 0.5), legend.position = "bottom",   legend.box = "horizontal" 
    )  + labs(x = "Sample Size (n)", y = "RMSE", color = "Estimator", group = "Estimator", shape= "Estimator") 
    ggsave(filename = paste0("DR=", pos_const,lrnr,misp, "MSE.pdf"), width = w, height = h)
    
    p <- ggplot(results_sub, aes(x= n, y = coverage, color = lrnr, shape= lrnr)) + geom_point(size = 4) + geom_line( color="grey", linetype = "dashed")  + facet_wrap(~estimator, ncol =2)+ scale_y_continuous(limits = c(min(results_sub$coverage), 0.97)) + geom_hline(yintercept = 0.95, color = "grey") + theme_bw() +     theme(  text = element_text(size=18), axis.text.x = element_text(size = 14 , hjust = 1, vjust = 0.5), legend.position = "bottom",   legend.box = "horizontal" 
    )  + labs(x = "Sample Size (n)", y = "CI Coverage", color = "Estimator", group = "Estimator", shape= "Estimator")  
    
    
    ggsave(filename = paste0("DR=", pos_const,lrnr,misp, "CI.pdf"), width = w, height = h)
  }
}
 

```

```{r}
library(ggplot2)
w <- 7
h <- 5
results$misp <- c("Both", "Treatment", "Outcome" )[match(results$misp, c("1", "2", "3" ))]

for(lrnr in c("all")) {
  for(misp in c("Both", "Treatment", "Outcome" )) {
    tmp <- results
    tmp <- as.data.frame(tmp)[tmp$lrnr == lrnr,]
    tmp <- as.data.frame(tmp)[tmp$misp == misp,]
    
    
    #maxval <- 3*min(tmp$rmse[tmp$n ==500])
    maxval <- max(tmp$rmse )
    tmp$bias <- pmin(tmp$bias, maxval)
    tmp$se <- pmin(tmp$se, maxval)
    tmp$mse <- pmin(tmp$rmse, maxval)
    
    limits <- c(0, maxval + .01)
    p <-  ggplot(tmp, aes(x= n, y = bias, color = lrnr, shape= lrnr)) + geom_point(size = 4) + geom_line( color="grey", linetype = "dashed") +  facet_wrap(~estimator, ncol =2)  + theme_bw() +     theme(  text = element_text(size=18), axis.text.x = element_text(size = 14 , hjust = 1, vjust = 0.5), legend.position = "bottom",   legend.box = "horizontal" 
    )  + labs(x = "Sample Size (n)", y = "Bias", color = "Estimator", group = "Estimator", shape= "Estimator") +  scale_y_continuous( limits = limits) 
    
    ggsave(   filename = paste0("DR=", pos_const,lrnr,misp, "Bias.pdf") , width = w, height = h)
    
    
    
    
    
    
    ggplot(tmp, aes(x= n, y = se, color = lrnr, shape= lrnr)) + geom_point(size = 4) + geom_line( color="grey", linetype = "dashed")  + facet_wrap(~estimator, ncol =2) + theme_bw()  +     theme(  text = element_text(size=18), axis.text.x = element_text(size = 14 , hjust = 1, vjust = 0.5), legend.position = "bottom",   legend.box = "horizontal" 
    )  + labs(x = "Sample Size (n)", y = "Standard Error", color = "Estimator", group = "Estimator", shape= "Estimator") +  scale_y_continuous( limits = limits)
    
    ggsave(filename = paste0("DR=", pos_const,lrnr,misp, "SE.pdf"), width = w, height = h)
    
    
    ggplot(tmp, aes(x= n, y = mse, color = lrnr, shape= lrnr)) + geom_point(size = 4)  + geom_line( color="grey", linetype = "dashed") + facet_wrap(~estimator, ncol =2) + theme_bw()  +     theme(  text = element_text(size=18), axis.text.x = element_text(size = 14 , hjust = 1, vjust = 0.5), legend.position = "bottom",   legend.box = "horizontal" 
    )  + labs(x = "Sample Size (n)", y = "Root Mean Square Error", color = "Estimator", group = "Estimator", shape= "Estimator")  +  scale_y_continuous( limits = limits)
    
    ggsave(filename = paste0("DR=", pos_const,lrnr,misp, "MSE.pdf"), width = w, height = h)
    
    p <- ggplot(tmp, aes(x= n, y = coverage, color = lrnr, shape= lrnr)) + geom_point(size = 4) + geom_line( color="grey", linetype = "dashed")  + facet_wrap(~estimator, ncol =2)+ scale_y_continuous(limits = c(min(tmp$coverage), 0.97)) + geom_hline(yintercept = 0.95, color = "grey") + theme_bw() +     theme(  text = element_text(size=18), axis.text.x = element_text(size = 14 , hjust = 1, vjust = 0.5), legend.position = "bottom",   legend.box = "horizontal" 
    )  + labs(x = "Sample Size (n)", y = "CI Coverage", color = "Estimator", group = "Estimator", shape= "Estimator")  
    
    
    ggsave(filename = paste0("DR=", pos_const,lrnr,misp, "CI.pdf"), width = w, height = h)
  }
}


p <- ggplot(tmp, aes(x= n, y = coverage, color = lrnr, shape= lrnr)) + geom_point(size = 4) + facet_wrap(~estimator, ncol =2)+ scale_y_log10() + geom_hline(yintercept = 0.95, color = "grey") + theme_bw() +     theme(  text = element_text(size=18), axis.text.x = element_text(size = 14 , hjust = 1, vjust = 0.5), legend.position = "bottom",   legend.box = "horizontal" , legend.title = element_blank()
)  + labs(x = "Sample Size (n)", y = "CI Coverage", color = "estimator", group = "estimator", shape= "estimator")  


```



```{r}

results[n >= 1000 & pos == 4e-02]

```
